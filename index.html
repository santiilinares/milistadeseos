<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi Lista de Deseos</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3730/3730613.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .intro-image img { width: 100px; height: 100px; object-fit: cover; }
    #countdown { font-size: 1.25rem; animation: glow 3s ease-in-out infinite; text-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
    @keyframes glow { 0% { color: #dc3545; text-shadow: 0 0 8px rgba(255, 215, 0, 0.4); } 50% { color: #ffc107; text-shadow: 0 0 16px rgba(255,255,0,0.7); } 100% { color: #dc3545; text-shadow: 0 0 8px rgba(255, 215, 0, 0.4); } }
    #progress-container { max-width: 400px; margin: 0 auto 20px auto; }
    .wish-card img { object-fit: cover; height: 200px; transition: transform 0.3s ease; cursor: pointer; }
    .wish-card img:hover { transform: scale(1.05); }
    .wish-card { opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
    .wish-card.show { opacity: 1; transform: translateY(0); }
    .preview-img { height: 100px; object-fit: cover; border-radius: 8px; display: none; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">üéÅ Mi Lista de Deseos</span>
    </div>
  </nav>

  <div class="intro-image text-center my-3">
    <img src="https://img1.picmix.com/output/stamp/normal/0/2/3/0/1100320_722ba.png" alt="Imagen de introducci√≥n" class="img-fluid rounded-circle shadow-sm">
    <p class="mt-2 text-muted">Bienvenido a mi lista de deseos üéÖ</p>
  </div>

  <div class="text-center mb-2">
    <h5 class="fw-semibold" id="countdown"></h5>
  </div>

  <div id="progress-container">
    <div class="progress">
      <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" id="reyesProgress"></div>
    </div>
  </div>

  <div class="container">
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title" id="formTitle">A√±adir nuevo deseo</h5>
        <form id="wishForm" class="row g-3">
          <div class="col-md-3">
            <input type="text" id="wishTitle" class="form-control" placeholder="T√≠tulo del deseo" required>
          </div>
          <div class="col-md-3">
            <input type="url" id="wishLink" class="form-control" placeholder="Enlace (opcional)">
          </div>
          <div class="col-md-3">
            <input type="number" id="wishPrice" class="form-control" placeholder="Precio (‚Ç¨)" min="0" step="0.01">
          </div>

          <div class="col-md-3">
            <select id="imageType" class="form-select">
              <option value="url" selected>Usar enlace de imagen</option>
              <option value="upload">Subir imagen</option>
            </select>
          </div>

          <div class="col-md-6" id="urlInputContainer">
            <input type="url" id="wishImageURL" class="form-control" placeholder="URL de la imagen (opcional)">
          </div>

          <div class="col-md-6" id="fileInputContainer" style="display: none;">
            <input type="file" id="wishImageFile" class="form-control" accept="image/*">
          </div>

          <div class="col-12 text-center">
            <img id="imagePreview" class="preview-img mt-2" alt="Vista previa">
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-success" id="submitButton">A√±adir a la lista</button>
            <button type="button" class="btn btn-secondary" id="cancelEditButton" style="display:none;">Cancelar edici√≥n</button>
          </div>
        </form>
      </div>
    </div>

    <div class="text-end mb-3" id="shareControls" style="display:none;">
      <button id="shareButton" class="btn btn-outline-primary">üîó Generar enlace compartible (subir a JSONBin)</button>
    </div>

    <div id="shareBox" class="card card-body mb-4" style="display:none;">
      <p class="mb-2">Enlace listo para compartir:</p>
      <input id="shareLink" class="form-control mb-2" readonly>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-secondary" id="copyBtn">üìã Copiar al portapapeles</button>
        <button class="btn btn-sm btn-outline-danger" id="revokeBtn" style="display:none;">üîÅ Revocar bin guardado localmente</button>
      </div>
    </div>

    <div id="wishlist" class="row g-4"></div>
  </div>

  <script>
    // ------------------------
    // CONFIG: pega TU NUEVA API KEY AQUI (NO uses la que ya expusiste p√∫blicamente)
    // ------------------------
    const JSONBIN_API_KEY = "$2a$10$nSFiU2LxJTNF3BRq6.q68uxdE9whnjxQr5eeIsFA1aCK2f5BHOqFm"; // <- pega tu nueva clave aqu√≠ (mant√©nla privada)
    const JSONBIN_BASE = "https://api.jsonbin.io/v3/bins";

    // ---------------------------------------------------
    // UI elementos
    // ---------------------------------------------------
    const form = document.getElementById('wishForm');
    const wishlist = document.getElementById('wishlist');
    const shareButton = document.getElementById('shareButton');
    const shareBox = document.getElementById('shareBox');
    const shareLink = document.getElementById('shareLink');
    const shareControls = document.getElementById('shareControls');
    const imageType = document.getElementById('imageType');
    const urlInput = document.getElementById('wishImageURL');
    const fileInput = document.getElementById('wishImageFile');
    const urlContainer = document.getElementById('urlInputContainer');
    const fileContainer = document.getElementById('fileInputContainer');
    const preview = document.getElementById('imagePreview');
    const formTitle = document.getElementById('formTitle');
    const submitButton = document.getElementById('submitButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const progressBar = document.getElementById('reyesProgress');
    const copyBtn = document.getElementById('copyBtn');
    const revokeBtn = document.getElementById('revokeBtn');

    // ---------------------------------------------------
    // Datos
    // ---------------------------------------------------
    let wishes = JSON.parse(localStorage.getItem('wishlist')) || [];
    let editIndex = null;

    // Guardamos localmente el binId creado por JSONBin para poder actualizarlo despu√©s
    const LOCAL_BIN_KEY = 'wishlist_bin_id';

    // ---------------------------------------------------
    // UI handlers
    // ---------------------------------------------------
    imageType.addEventListener('change', () => {
      if (imageType.value === 'upload') {
        urlContainer.style.display = 'none';
        fileContainer.style.display = 'block';
        preview.style.display = 'none';
        preview.src = '';
        fileInput.value = '';
        setTimeout(() => fileInput.click(), 100);
      } else {
        fileContainer.style.display = 'none';
        urlContainer.style.display = 'block';
        preview.style.display = 'none';
        preview.src = '';
        fileInput.value = '';
      }
    });

    urlInput.addEventListener('input', () => {
      if (urlInput.value.trim()) {
        preview.src = urlInput.value;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else preview.style.display = 'none';
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const title = document.getElementById('wishTitle').value;
      const link = document.getElementById('wishLink').value;
      const price = document.getElementById('wishPrice').value;

      let image = '';
      if (imageType.value === 'url') {
        image = urlInput.value || 'https://via.placeholder.com/400x200?text=Sin+Imagen';
      } else if (fileInput.files.length > 0) {
        image = preview.src;
      } else image = 'https://via.placeholder.com/400x200?text=Sin+Imagen';

      const newWish = { title, link, image, price };

      if (editIndex !== null) {
        wishes[editIndex] = newWish;
        editIndex = null;
        formTitle.textContent = "A√±adir nuevo deseo";
        submitButton.textContent = "A√±adir a la lista";
        cancelEditButton.style.display = "none";
      } else {
        wishes.push(newWish);
      }

      localStorage.setItem('wishlist', JSON.stringify(wishes));
      renderWishes();

      form.reset();
      fileInput.value = '';
      preview.style.display = 'none';
      preview.src = '';
    });

    cancelEditButton.addEventListener('click', () => {
      editIndex = null;
      form.reset();
      fileInput.value = '';
      preview.style.display = 'none';
      formTitle.textContent = "A√±adir nuevo deseo";
      submitButton.textContent = "A√±adir a la lista";
      cancelEditButton.style.display = "none";
    });

    function renderWishes() {
      wishlist.innerHTML = '';
      wishes.forEach((wish, index) => {
        const col = document.createElement('div');
        col.classList.add('col-md-4');
        col.innerHTML = `
          <div class="card wish-card shadow-sm">
            ${wish.link ? `<a href="${wish.link}" target="_blank" rel="noopener"><img src="${wish.image}" class="card-img-top" alt="${wish.title}"></a>` :
            `<img src="${wish.image}" class="card-img-top" alt="${wish.title}">`}
            <div class="card-body">
              <h5 class="card-title">${wish.title}</h5>
              ${wish.price ? `<p class="text-success fw-bold">üí∞ ${parseFloat(wish.price).toFixed(2)} ‚Ç¨</p>` : ''}
              ${wish.link ? `<a href="${wish.link}" target="_blank" rel="noopener" class="btn btn-outline-primary mb-2">Ver enlace</a>` : ''}
              <div class="d-flex justify-content-between">
                <button class="btn btn-outline-warning btn-sm" onclick="editWish(${index})">‚úèÔ∏è Editar</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteWish(${index})">üóëÔ∏è Eliminar</button>
              </div>
            </div>
          </div>
        `;
        wishlist.appendChild(col);
        setTimeout(() => col.firstElementChild.classList.add('show'), 50);
      });
      shareControls.style.display = wishes.length > 0 ? 'block' : 'none';
      // mostrar si existe binId guardado localmente (posible auto-actualizaci√≥n)
      revokeBtn.style.display = localStorage.getItem(LOCAL_BIN_KEY) ? 'inline-block' : 'none';
    }

    // Hacer funciones globales para poder usarlas desde el HTML generado (editar/eliminar)
    window.editWish = function(index) {
      const wish = wishes[index];
      editIndex = index;
      formTitle.textContent = "‚úèÔ∏è Editar deseo";
      submitButton.textContent = "Guardar cambios";
      cancelEditButton.style.display = "inline-block";

      document.getElementById('wishTitle').value = wish.title;
      document.getElementById('wishLink').value = wish.link;
      document.getElementById('wishPrice').value = wish.price;
      urlInput.value = wish.image;
      preview.src = wish.image;
      preview.style.display = 'block';
      imageType.value = 'url';
      urlContainer.style.display = 'block';
      fileContainer.style.display = 'none';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteWish = function(index) {
      const card = wishlist.children[index].firstElementChild;
      card.classList.remove('show');
      setTimeout(() => {
        wishes.splice(index, 1);
        localStorage.setItem('wishlist', JSON.stringify(wishes));
        renderWishes();
      }, 300);
    };

    // ---------------------------------------------------
    // JSONBin: crear/actualizar y leer
    // ---------------------------------------------------

    async function createBin(data) {
      const res = await fetch(JSONBIN_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_API_KEY,
          'X-Bin-Private': 'true'
        },
        body: JSON.stringify({ wishlist: data })
      });
      if (!res.ok) throw new Error('Error creando bin');
      const json = await res.json();
      return json?.metadata?.id || null;
    }

    async function updateBin(binId, data) {
      const res = await fetch(`${JSONBIN_BASE}/${binId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_API_KEY
        },
        body: JSON.stringify({ wishlist: data })
      });
      if (!res.ok) throw new Error('Error actualizando bin');
      const json = await res.json();
      return json?.metadata?.id || binId;
    }

    async function loadBinPublic(binId) {
      // Intentamos leer la versi√≥n p√∫blica (latest) sin exponer la clave.
      const res = await fetch(`${JSONBIN_BASE}/${binId}/latest`);
      if (!res.ok) throw new Error('No se pudo leer el bin p√∫blico');
      const json = await res.json();
      return json?.record?.wishlist || [];
    }

    // Crear o actualizar el bin guardando el binId en localStorage para futuras ediciones
    async function uploadOrUpdateWishlist(data) {
      if (!JSONBIN_API_KEY || JSONBIN_API_KEY === "TU_API_KEY_AQUI") {
        throw new Error("Debes configurar tu JSONBIN_API_KEY en el archivo antes de subir.");
      }

      const existingBinId = localStorage.getItem(LOCAL_BIN_KEY);
      try {
        if (existingBinId) {
          // Intentamos actualizar primero
          const updatedId = await updateBin(existingBinId, data);
          return updatedId;
        } else {
          // Crear nuevo bin
          const newId = await createBin(data);
          if (newId) localStorage.setItem(LOCAL_BIN_KEY, newId);
          return newId;
        }
      } catch (err) {
        // Si actualizar fall√≥ y no hab√≠a bin, intentar crear de nuevo
        console.error(err);
        if (!existingBinId) {
          const newId = await createBin(data);
          if (newId) localStorage.setItem(LOCAL_BIN_KEY, newId);
          return newId;
        }
        throw err;
      }
    }

    // Evento del bot√≥n compartir
    shareButton.addEventListener('click', async () => {
      shareBox.style.display = 'block';
      shareLink.value = "Procesando...";

      try {
        const binId = await uploadOrUpdateWishlist(wishes);
        if (!binId) throw new Error('No se obtuvo binId');

        const shareUrl = `${location.origin}${location.pathname}#bin=${binId}`;
        shareLink.value = shareUrl;
        alert('‚úÖ Lista subida correctamente. Comparte el enlace con quien quieras.');
        revokeBtn.style.display = 'inline-block';
      } catch (err) {
        console.error(err);
        shareLink.value = "‚ùå Error subiendo la lista";
        alert('No se pudo subir la lista. Revisa la consola y tu API key.');
      }
    });

    // Cargar un bin por su id (se intenta lectura p√∫blica)
    async function loadWishlistFromBin(binId) {
      try {
        const data = await loadBinPublic(binId);
        wishes = data;
        renderWishes();
      } catch (err) {
        console.error('Lectura p√∫blica fallida, intentando con clave...', err);
        // Intentamos leer con clave (por si el bin no est√° p√∫blico)
        try {
          const res = await fetch(`${JSONBIN_BASE}/${binId}/latest`, {
            headers: { 'X-Master-Key': JSONBIN_API_KEY }
          });
          if (!res.ok) throw new Error('No se pudo leer el bin incluso con clave');
          const json = await res.json();
          wishes = json.record.wishlist || [];
          renderWishes();
        } catch (err2) {
          console.error(err2);
          alert('No se pudo cargar la lista compartida. Puede que el ID sea inv√°lido o la lista no est√© disponible p√∫blicamente.');
        }
      }
    }

    // Detectar #bin=ID en la URL
    if (location.hash.startsWith('#bin=')) {
      const binId = location.hash.slice(5);
      if (binId) loadWishlistFromBin(binId);
    }

    // Copiar al portapapeles (API moderna)
    copyBtn.addEventListener('click', async () => {
      const text = shareLink.value;
      try {
        await navigator.clipboard.writeText(text);
        alert('¬°Enlace copiado al portapapeles!');
      } catch {
        // fallback
        shareLink.select();
        document.execCommand('copy');
        alert('¬°Enlace copiado al portapapeles! (fallback)');
      }
    });

    // Revoke: eliminar binId local (no borra del servidor)
    revokeBtn.addEventListener('click', () => {
      localStorage.removeItem(LOCAL_BIN_KEY);
      revokeBtn.style.display = 'none';
      alert('ID local revocado. La URL compartida sigue existiendo en JSONBin pero ya no se actualizar√° desde este navegador.');
    });

    // ---------------------------------------------------
    // Countdown / progress
    // ---------------------------------------------------
    function updateCountdown() {
      const targetDate = new Date("2026-01-06T00:00:00");
      const now = new Date();
      const diff = targetDate - now;
      const days = Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));

      const countdownEl = document.getElementById("countdown");
      if (days > 0) {
        countdownEl.textContent = `üéÅ Faltan ${days} d√≠a${days === 1 ? '' : 's'} para el D√≠a de Reyes üëë`;
      } else {
        countdownEl.textContent = "üëë ¬°Feliz D√≠a de Reyes! üéâ";
      }

      const startDate = new Date("2025-01-01T00:00:00");
      const totalDays = (targetDate - startDate) / (1000*60*60*24);
      const elapsedDays = (now - startDate) / (1000*60*60*24);
      const percent = Math.min(100, Math.max(0, (elapsedDays / totalDays) * 100));
      progressBar.style.width = percent + "%";
    }

    updateCountdown();
    setInterval(updateCountdown, 1000 * 60 * 60);
    renderWishes();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
